#!/usr/bin/env bash
# setup environment

#
# CONFIG
#
RUBY_VERSION=1.9.2
GIT_REPO=https://github.com/delonnewman/dotfiles.git
TMP_DIR=/tmp
PREREQS=(git curl build-essential bison openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev)
PACKAGES=(vim tig openssh-client)
GEMS=(rails sinatra datamapper haml rake)

#
# COLORS
#

function install {
	pkgs=$@
	for pkg in ${pkgs[@]}; do
		path=$(which $pkg)
		if [ -z $path ]; then
			echo Installing $pkg...
			sudo apt-get -y --force-yes install $pkg
			echo DONE.
		else
			echo $pkg is already installed.
		fi
	done

}

echo "=> Installing prereqs..."
echo

# install prereqs
install ${PREREQS[@]}

# install RVM
if [[ -s "$HOME/.rvm/scripts/rvm" ]]; then
	echo rvm is already installed.
else
	bash < <(curl -s https://rvm.beginrescueend.com/install/rvm)
	bash # reload bash env
fi

# install ruby with RVM
ruby=$(ruby -v)
if [[ $ruby =~ $RUBY_VERSION ]]; then
	echo ruby-$RUBY_VERSION is already installed.
else
	# install ruby version and set as default
	[[ -s "$HOME/.rvm/scripts/rvm" ]] && . "$HOME/.rvm/scripts/rvm" # Load RVM function
	rvm install $RUBY_VERSION && rvm use $RUBY_VERSION --default
fi

echo
echo '==> installing some default gems...'

rvm gem install ${GEMS[@]}

echo 'DONE.'
echo

echo
echo 'DONE. -->  WOOT!'
echo ===================================================================
echo "==> fetching dotfiles repo from $GIT_REPO into $TMP_DIR..."
echo

# install dotfiles
cd $TMP_DIR &&
git clone $GIT_REPO &&
cd dotfiles &&
rake install &&

# clean-up
if [[ -e "$TMP_DIR/dotfiles" ]]; then
	rm -rf "$TMP_DIR/dotfiles"
fi

# install other packages
echo
echo OK, the basics are done. Installing some other useful packages...
echo '====>'

install ${PACKAGES[@]}

echo
echo 'DONE. --> --> -->'
echo
echo 'Your environment is configured as best I know how ;-)'
